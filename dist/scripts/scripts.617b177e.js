"use strict";!function(){var a=document.getElementsByClassName("east-slider")[0],b=document.getElementsByClassName("pane_container")[0],c=document.getElementsByClassName("pane_east")[0],d=document.getElementsByClassName("pane_main")[0];c.style.left=a.style.left=b.offsetWidth-20+"px";var e=function(e){a.style.left=e+"px",c.style.left=6+e+"px",d.style.width=e+"px",c.style.width=b.offsetWidth-e+"px"},f=function(a){e(a.clientX)},g=function(){return document.onmousemove=f,c.style.display="block",!1},h=function(){document.onmousemove=null};a.onmousedown=g,document.onmouseup=h;var i=!1,j=function(){i=!i,i?(a.onmousedown=g,document.onmouseup=h,e(b.offsetWidth-300),$(a).show(),$(c).show()):(a.onmousedown=null,document.onmouseup=null,$(a).hide(),$(c).hide(),e(b.offsetWidth))},k=function(){i||j()};$(window).on("resize",function(){e(i?b.offsetWidth-300:b.offsetWidth)}),$(document).on("toggleEast",j),$(document).on("openEast",k)}(),function(){var a=function(b,c,d){this.completed=!1,this.$$myFn=b,this.then=function(b,c,d){return c instanceof Array&&(d=c,c=void 0),this.next=new a(b,c,d),this.completed&&this.completer(),this.next},this.apply=function(){b.promise=this,b.apply(c,d)},this.completer=function(){this.completed=!0,this.next&&(this.next.apply(),this.completed=!1)},this.complete=this.completer.bind(this)};a.create=function(b){if(b.hasOwnProperty("promise"))return b.promise;var c=new a;return c},window.Promise=a}(),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0===this.indexOf(a)}),"function"!=typeof String.prototype.hasSubstr&&(String.prototype.hasSubstr=function(a){return-1!==this.indexOf(a)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)}),angular.module("splain-app",["LocalStorageModule","ui.bootstrap","gd.ui.jsonexplorer"]),angular.module("splain-app").directive("dispatchOnClick",function(){return{restrict:"A",priority:1e3,link:function(a,b,c){b.on("click",function(){var a=c.dispatchOnClick;b.trigger(a)})}}}),angular.module("splain-app").directive("docRow",function(){return{restrict:"E",priority:1e3,scope:{doc:"="},templateUrl:"views/docRow.html",controller:"DocRowCtrl"}}),angular.module("splain-app").filter("stackChartColor",function(){var a=["red","orange","green","blue"];return function(b){var c=b%a.length;return"chart-area "+a[c]}}),angular.module("splain-app").filter("stackChartHeight",function(){return function(a){return{height:a+"%"}}}),angular.module("splain-app").filter("stackChartLeftover",function(){return function(a){var b=100;return angular.forEach(a,function(a){b-=a.percentage}),0>b&&(b=0),{height:b+"%"}}}),angular.module("splain-app").directive("stackedChart",function(){return{restrict:"E",priority:1e3,scope:{hots:"="},templateUrl:"views/stackedChart.html"}}),angular.module("splain-app").service("explainSvc",["vectorSvc",function(a){var b=function(a){var b=a.influencers();return 1===b.length?b[0]:a},c=/max plus ([0-9.]+) times/,d=function(a){var d=new e(a),n=a.description,o=[];a.hasOwnProperty("details")&&(o=a.details);var p=n.match(c);if(n.startsWith("MatchAllDocsQuery"))return console.log("Match all docs query"),f.prototype=d,new f(a);if(n.startsWith("weight("))return g.prototype=d,console.log("weight"),new g(a);if(n.startsWith("FunctionQuery"))return console.log("func query"),h.prototype=d,new h(a);if(p&&p.length>1){console.log("dismax tie expl");var q=parseFloat(p[1]);return j.prototype=d,new j(a,q)}if(n.hasSubstr("max of"))return console.log("dismax expl"),k.prototype=d,b(new k(a));if(n.hasSubstr("sum of"))return l.prototype=d,console.log("sum or product expl"),b(new l(a));if(n.hasSubstr("product of")){var r=null;return 2===o.length&&angular.forEach(o,function(b){b.description.startsWith("coord(")&&(i.prototype=d,r=new i(a,parseFloat(b.value)))}),console.log("product expl"),null!==r?r:(m.prototype=d,b(new m(a)))}return console.log("regular explain"),d},e=function(b){var c=this;this.asJson=b,this.realContribution=this.score=parseFloat(b.value),this.realExplanation=this.description=b.description;var e=[];b.hasOwnProperty("details")&&(e=b.details),this.children=[],angular.forEach(e,function(a){c.children.push(d(a))}),this.influencers=function(){return[]},this.contribution=function(){return this.realContribution},this.explanation=function(){return this.realExplanation},this.vectorize=function(){var b=a.create();return b.set(this.explanation(),this.contribution()),b},this.toStr=function(a){void 0===a&&(a=0);var b=new Array(2*a).join(" "),c=b+this.contribution()+" "+this.explanation()+"\n",d=[];return angular.forEach(this.influencers(),function(b){d.push(b.toStr(a+1))}),c+d.join("\n")},this.rawStr=function(){return JSON.stringify(this.asJson)}},f=function(){this.realExplanation="You queried *:* (all docs returned w/ score of 1)"},g=function(a){var b=/weight\((.*?)\s+in\s+\d+?\)/,c=a.description,d=c.match(b);this.realExplanation=null!==d&&d.length>1?d[1]:c},h=function(a){var b=/FunctionQuery\((.*)\)/,c=a.description,d=c.match(b);this.realExplanation=null!==d&&d.length>1?d[1]:c},i=function(b,c){1>c&&(this.realExplanation="Matches Punished by "+c+" (not all query terms matched)",this.influencers=function(){for(var a=[],b=0;b<this.children.length;b++)this.children[b].description.hasSubstr("coord")||a.push(this.children[b]);return a},this.vectorize=function(){var b=a.create();return angular.forEach(this.influencers(),function(c){b=a.add(b,c.vectorize())}),b=a.scale(b,c)})},j=function(b,c){this.realExplanation="Dismax (max plus:"+c+" times others",this.influencers=function(){var a=angular.copy(this.children);return a.sort(function(a,b){return b.score-a.score}),a},this.vectorize=function(){var b=this.influencers(),d=b[0].vectorize();return angular.forEach(b.slice(1),function(b){var e=b.vectorize(),f=a.scale(e,c);d=a.add(d,f)}),d}},k=function(){this.realExplanation="Dismax (take winner of below)",this.influencers=function(){var a=angular.copy(this.children);return a.sort(function(a,b){return b.score-a.score}),a},this.vectorize=function(){var a=this.influencers();return a[0].vectorize()}},l=function(){this.realExplanation="Sum of the following:",this.isSumExplain=!0,this.influencers=function(){var a=angular.copy(this.children);a.sort(function(a,b){return b.score-a.score});var b=[];return angular.forEach(a,function(a){a.hasOwnProperty("isSumExplain")&&a.isSumExplain?angular.forEach(a.influencers(),function(a){b.push(a)}):b.push(a)}),b},this.vectorize=function(){var b=a.create();return angular.forEach(this.influencers(),function(c){b=a.add(b,c.vectorize())}),b}},m=function(){this.realExplanation="Product of following:";var b=function(a){return Array.apply(null,new Array(a)).map(Number.prototype.valueOf,1)};this.influencers=function(){var a=angular.copy(this.children);return a.sort(function(a,b){return b.score-a.score}),a},this.vectorize=function(){for(var c=a.create(),d=this.influencers(),e=b(d.length),f=0;f<d.length;f++)for(var g=0;g<d.length;g++)g!==f&&(e[f]=e[f]*d[g].contribution());for(var h=0;h<d.length;h++){var i=d[h],j=i.vectorize(),k=a.scale(j,e[h]);c=a.add(c,k)}return c}};this.createExplain=function(a){return d(a)}}]),angular.module("splain-app").service("normalDocsSvc",["explainSvc",function(a){var b=function(a,b,c,d){b.hasOwnProperty(c)&&(a[d]=b[c].slice(0,200))},c=function(a,c,d){b(a,c,d.id,"id"),b(a,c,d.title,"title"),b(a,c,d.thumb,"thumb"),a.subs={},angular.forEach(d.subs,function(b){c.hasOwnProperty(b)&&(a.subs[b]=c[b])})},d=function(b,d){this.solrDoc=d,c(this,d,b);var e=!1;this.hasOwnProperty("thumb")&&(e=!0),this.subsList=[];var f=this;angular.forEach(this.subs,function(a,b){"string"==typeof a&&(a=a.slice(0,200));var c={field:b,value:a};f.subsList.push(c)}),this.hasThumb=function(){return e},this.url=function(){return this.solrDoc.url(b.id,this.id)};var g=this.solrDoc.explain(this.id),h=a.createExplain(g),i=h.toStr(),j=h.vectorize().toStr();this.explain=function(){return h},this.explainSummary=function(){return i},this.hotMatches=function(){return j},this.score=h.contribution()};this.createNormalDoc=function(a,b){return new d(a,b)},this.createPlaceholderDoc=function(a,b){return{id:a,title:b}}}]),angular.module("splain-app").service("vectorSvc",function(){var a=function(){this.vecObj={},this.set=function(a,b){this.vecObj[a]=b},this.get=function(a){return this.vecObj.hasOwnProperty(a)?this.vecObj[a]:void 0},this.toStr=function(){var a="",b=[];return angular.forEach(this.vecObj,function(a,c){b.push([c,a])}),b.sort(function(a,b){return b[1]-a[1]}),angular.forEach(b,function(b){a+=b[1]+" "+b[0]+"\n"}),a}};this.create=function(){return new a},this.add=function(a,b){var c=this.create();return angular.forEach(a.vecObj,function(a,b){c.set(b,a)}),angular.forEach(b.vecObj,function(a,b){c.set(b,a)}),c},this.scale=function(a,b){var c=this.create();return angular.forEach(a.vecObj,function(a,d){c.set(d,a*b)}),c}}),angular.module("splain-app").service("settingsStoreSvc",["localStorageService","solrSearchSvc",function(a,b){var c=function(a){delete a.fl,delete a.wt,delete a.rows},d=function(a){var d=b.parseSolrUrl(a.solrUrl);if(null!==d&&d.solrArgs&&Object.keys(d.solrArgs).length>0){var e=angular.copy(d.solrArgs);if(c(e),a.solrArgsStr=b.formatSolrArgs(e),d.solrArgs.hasOwnProperty("fl")){var f=d.solrArgs.fl;a.fieldSpecStr=f[0]}}a.solrUrl=d.solrEndpoint()},e=function(){var b={solrUrl:"",fieldSpecStr:"",solrArgsStr:""},c=function(c){var d=a.get(c);b[c]=null!==d?d:""};return a.isSupported&&(c("solrUrl"),c("fieldSpecStr"),c("solrArgsStr")),b},f=function(b){a.isSupported&&(a.set("solrUrl",b.solrUrl),a.set("fieldSpecStr",b.fieldSpecStr),a.set("solrArgsStr",b.solrArgsStr))},g=e();this.get=function(){return g},this.parse=function(){d(g)},this.commit=function(){f(g)},this.fromStartUrl=function(a){g.solrUrl=a,this.parse()}}]),angular.module("splain-app").service("solrSearchSvc",["$http",function(a){var b=0,c=function(a,b){var c=a+"?";return angular.forEach(b,function(a,b){angular.forEach(a,function(a){c+=b+"="+a+"&"})}),c=c.replace(/%/g,"%25"),c.slice(0,-1)},d=this,e=function(a,b,e,f){var g=encodeURIComponent(d.escapeUserQuery(f)),h={indent:["true"],wt:["xml"],facet:["true"],"facet.field":[],"facet.mincount":["1"]};return angular.forEach(a,function(a){"score"!==a&&h["facet.field"].push(a)}),c(b,h)+"&q="+e+":"+g},f=function(a,b,d,e){d.fl=[a.join(" ")],d.wt=["json"],d.debug=["true"],d["debug.explain.structured"]=["true"];var f=c(b,d);return f=f.replace(/#\$query##/g,encodeURIComponent(e))},g=function(c,d,g,h){this.callUrl=this.linkUrl="",this.callUrl=f(c,d,g,h),this.linkUrl=this.callUrl.replace("wt=json","wt=xml"),this.linkUrl=this.linkUrl+"&indent=true&echoParams=all",this.docs=[],this.numFound=0,this.inError=!1,this.search=function(){var f=this.callUrl+"&json.wrf=JSON_CALLBACK";this.inError=!1;var g=Promise.create(this.search),h=this,i=function(a){if(a.hasOwnProperty("debug")){var b=a.debug;if(b.hasOwnProperty("explain"))return b.explain}return{}};return b++,a.jsonp(f).success(function(a){b--,h.numFound=a.response.numFound;var f=i(a);angular.forEach(a.response.docs,function(a){a.url=function(a,b){return e(c,d,a,b)},a.explain=function(a){return f.hasOwnProperty(a)?f[a]:""},h.docs.push(a)}),g.complete()}).error(function(){b--,h.inError=!0,g.complete()}),g}};this.createSearcherFromSettings=function(a,b){return new g(a.createFieldSpec().fieldList(),a.solrUrl,a.selectedTry.solrArgs,b)},this.createSearcher=function(a,b,c,d){return new g(a,b,c,d)},this.activeQueries=function(){return b},this.escapeUserQuery=function(a){var b=["+","-","&","!","(",")","[","]","{","}","^",'"',"~","*","?",":","\\"],c=new RegExp("(\\"+b.join("|\\")+")","g");return a.replace(c,"\\$1")},this.parseSolrArgs=function(a){var b=a.split("?");2===b.length&&(a=b[1]);var c=a.split("&"),d={};return angular.forEach(c,function(a){var b=a.split("=");if(2===b.length){var c=b[0],e=b[1],f=decodeURIComponent(e);d.hasOwnProperty(c)?d[c].push(f):d[c]=[f]}}),d},this.formatSolrArgs=function(a){var b="";return angular.forEach(a,function(a,c){angular.forEach(a,function(a){b+=c+"="+a+"&"})}),b=b.replace(/%/g,"%25"),b.slice(0,-1)},this.parseSolrPath=function(a){a.startsWith("/")&&(a=a.slice(1));var b="solr/";if(a.startsWith(b)){a=a.slice(b.length);var c=a.split("/");if(2===c.length){var d=c[0],e=c[1];return e.endsWith("/")&&(e=e.slice(0,e.length-1)),{collectionName:d,requestHandler:e}}}return null},this.parseSolrUrl=function(a){var b=function(a){var b=document.createElement("a");return b.href=a,b},c=b(a);c.solrArgs=this.parseSolrArgs(c.search);var d=this.parseSolrPath(c.pathname);if(!d)return null;c.collectionName=d.collectionName,c.requestHandler=d.requestHandler;var e=function(){return c.protocol+"//"+c.host+c.pathname};return c.solrEndpoint=e,c}}]),angular.module("splain-app").service("fieldSpecSvc",function(){var a=function(a,b,c){"sub"===b?(a.hasOwnProperty("subs")||(a.subs=[]),a.subs.push(c)):a.hasOwnProperty(b)||(a[b]=c),a.fields.push(c)},b=function(b,c){var d=c.split(/[\s,]+/);angular.forEach(d,function(c){var d=c.split(":"),e=null,f=null;2===d.length?(e=d[0],f=d[1]):1===d.length&&(f=d[0],e=b.hasOwnProperty("title")?"sub":"title"),e&&f&&a(b,e,f)})},c=function(a){this.fields=[],this.fieldSpecStr=a,b(this,a),this.hasOwnProperty("id")||(this.id="id",this.fields.push("id")),this.hasOwnProperty("title")||(this.title=this.id),this.fieldList=function(){var a=[this.id];return this.forEachField(function(b){a.push(b)}),a},this.forEachField=function(a){this.hasOwnProperty("title")&&a(this.title),this.hasOwnProperty("thumb")&&a(this.thumb),angular.forEach(this.subs,function(b){a(b)})}};this.createFieldSpec=function(a){return new c(a)}}),angular.module("splain-app").controller("DocRowCtrl",["$scope","$modal",function(a,b){a.doc.showDetailed=function(){b.open({templateUrl:"views/detailedExplain.html",controller:"DocExplainCtrl",resolve:{doc:function(){return a.doc}}})}}]),angular.module("splain-app").controller("DocExplainCtrl",["$scope","doc",function(a,b){a.doc=b}]),angular.module("splain-app").controller("MainCtrl",["$scope","solrSearchSvc","fieldSpecSvc","normalDocsSvc","settingsStoreSvc",function(a,b,c,d,e){a.main={},a.main.searcher=null,a.main.docs=[],a.main.NO_SEARCH=0,a.main.DID_SEARCH=1,a.main.WAITING_FOR_SEARCH=2,a.main.IN_ERROR=3,a.main.state=a.main.NO_SEARCH,a.main.linkUrl="#",a.main.numFound=0;var f=e.get();a.main.search=function(){var e=Promise.create(a.main.search),g=c.createFieldSpec(f.fieldSpecStr),h=b.parseSolrArgs(f.solrArgsStr);return a.main.solrSearcher=b.createSearcher(g.fieldList(),f.solrUrl,h,""),a.main.state=a.main.WAITING_FOR_SEARCH,a.main.solrSearcher.search().then(function(){if(a.main.linkUrl=a.main.solrSearcher.linkUrl,a.main.numFound=a.main.solrSearcher.numFound,a.main.solrSearcher.inError)return void(a.main.state=a.main.IN_ERROR);a.main.docs.length=0;var b=null;angular.forEach(a.main.solrSearcher.docs,function(c){var e=d.createNormalDoc(g,c);null===b&&(b=0+e.score),e.hots={outOf:b,matches:[]};var f=e.explain().vectorize(),h=0;angular.forEach(f.vecObj,function(a,c){e.hots.matches[h]={label:c,percentage:a/b*100},h++}),a.main.docs.push(e)}),a.main.state=a.main.DID_SEARCH,e.complete()}),e}}]),angular.module("splain-app").controller("SolrSettingsCtrl",["$scope","solrSearchSvc","fieldSpecSvc","normalDocsSvc","settingsStoreSvc",function(a,b,c,d,e){a.solrSettings=e.get(),a.solrSettings.publishSearcher=function(){e.parse(),a.main.search().then(function(){e.commit()})}}]),angular.module("splain-app").controller("StartUrlCtrl",["$scope","localStorageService","settingsStoreSvc",function(a,b,c){if(a.start={},a.start.startUrl="http://localhost:8983/solr/collection1/select",b.isSupported){var d=b.get("startUrl");a.start.startUrl=d}a.start.submit=function(){c.fromStartUrl(a.start.startUrl),a.main.search().then(function(){c.commit(),b.isSupported&&b.set("startUrl",a.start.startUrl)})}}]);